#!/bin/bash
#GUI dialog for saving session at PUPMODE 13
# --file parameter for saving user response in /tmp/session_ramdisk_result to be read by /etc/rc.d/rc.shutdown

. /etc/rc.d/PUPSTATE

if [ $PUPMODE -ne 13 ]; then
 echo "Not PUPMODE 13"
 exit 
fi

if [ "$1" == "--file" ]; then
 xMAKE_ANSWER="y"
fi

MSG="$(gettext 'Save session?

Press ENTER key to save session...
Or, press TAB then ENTER to not save session...
Or, wait 60 seconds to shutdown without saving session...')"

if [ "$(pidof -s $(cat /etc/windowmanager))" != "" ]; then
 [ "$DISPLAY" == "" ] && export DISPLAY=:0
 [ "$WAYLAND_DISPLAY" == "" ] && export WAYLAND_DISPLAY=wayland-0
 [ "$XDG_RUNTIME_DIR" == "" ] && export XDG_RUNTIME_DIR=/tmp/runtime-root
 yad --timeout=60 --timeout-indicator=bottom --text="$MSG" --button=gtk-yes --button=gtk-no
else
 dialog --timeout 60 --yesno "$MSG" 0 0
fi
RETVAL=$?

if [ "$xMAKE_ANSWER" != "" ]; then
  
 if [ $RETVAL -eq 0 ]; then
  echo "RAMDISK_SAVE_SESSION=y" > /tmp/session_ramdisk_result
 elif [ $RETVAL -eq 252 ]; then
  rm -f /tmp/session_ramdisk_result 2>/dev/null
  exit 255
 else
  echo "RAMDISK_SAVE_SESSION=n" > /tmp/session_ramdisk_result
 fi
 
else
 rm -f /tmp/session_ramdisk_result 2>/dev/null
fi
 
exit $RETVAL
