#!/bin/sh
# called from shutdown menu
# config files: ~/.jwmrc, etc
# script: wmexit -- symlinks: wmreboot wmpoweroff restartwm

export TEXTDOMAIN=wmexit
export OUTPUT_CHARSET=UTF-8

script=${0##*/}
script2=$1

case $script in wmexit|wmreboot|wmpoweroff|restartwm) OK=1 ;; esac
case $script2 in wmexit|wmreboot|wmpoweroff|restartwm) script=$script2 ; shift ; OK=1 ;; esac
[ ! "$OK" ] && echo "ERROR: $script is not valid" && exit 1
echo $script

#--------------
case $script in
   restartwm)
      EXITMODE="restartwm"
      ;;
   wmexit)
      ## Exit from X, will cause return to xwin ##
      EXITMODE="exit"
      ;;
   wmreboot|wmpoweroff)
      ## reboot/shutdown ##
      . /etc/rc.d/PUPSTATE
      if [ $PUPMODE -eq 13 ] ; then
         . /etc/eventmanager
         if [ "$ASKTOSAVE" = "true" ] ; then
            asktosave_session --file
            [ $? -eq 255 ] && exit #abort shutdown.
         fi
         #...writes results to /tmp/session_ramdisk_result, which /etc/rc.d/rc.shutdown reads.
      fi
      [ "$script" = 'wmreboot' ] && EXITMODE="reboot"
      [ "$script" = 'wmpoweroff' ] && EXITMODE="poweroff"
      ;;
esac

#/sbin/pup_event_frontend_d will quit if this file exists...
echo -n "$EXITMODE" > /tmp/wmexitmode.txt

###########################################################

while [ "`pidof snapmergepuppy`" ] ; do sleep 1 ; done

killall `cat /etc/windowmanager`

### END ###
