#!/bin/ash
# mounts and returns mount point
# return mount point if partition already mounted
# any error: return -ne 0

MNT_DEV="$1"  #ex: /dev/sda1
MNT_DIR="$2"  #ex: /mnt/sda1
MNT_FS="$3"    #ex: vfat
[ "$1" = "" ] && exit 1

#-----------------------------------------------------

xdev=${MNT_DEV##*/} #basename
if [ ! -b /dev/$xdev ] ; then
  echo "$xdev: not a valid block device" 1>&2
  exit 1
fi
MNT_DEV=/dev/$xdev

IS_MOUNTED=$(mount | grep "^/dev/$xdev " | cut -f 3 -d ' ')
if [ "$IS_MOUNTED" ] ; then
  [ ! "$INIT_SCRIPT" ] && echo $IS_MOUNTED
  exit
fi

[ -z "$MNT_DIR" ] && MNT_DIR=/mnt/$xdev
[ -z "$MNT_FS" ]  && MNT_FS=$(lsblk -no fstype /dev/$xdev 2>/dev/null)
mkdir -p ${MNT_DIR}

#-----------------------------------------------------

MNT_O='noatime'

case $MNT_FS in
  ntfs)
    mount $MNT_DEV $MNT_DIR -t ntfs3 -o umask=0,noatime,rw,silent 2>/dev/null #default is rw. 130211 add silent.
    ;;
  vfat)
    VFAT_OUT_PARAM='noatime,shortname=mixed,quiet,utf8' 
    mount -t $MNT_FS -o $VFAT_OUT_PARAM $MNT_DEV $MNT_DIR ;;
  #exfat) mount.exfat-fuse -o $MNT_O $MNT_DEV $MNT_DIR ;;
  *)
     mount -t $MNT_FS -o $MNT_O $MNT_DEV $MNT_DIR
     ;;
esac

RET=$?
[ "$RET" = "0" ] && [ ! "$INIT_SCRIPT" ] && echo $MNT_DIR
exit $RET

### END ###
